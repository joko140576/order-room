<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Pemesanan Ruang Rapat - PT SSI</title>

  <!-- Bootstrap 5 -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">

  <style>
    :root{
      --primary:#1565c0;
      --card-radius:14px;
    }
    body{
      background: linear-gradient(180deg,#f0f6ff 0%, #eaf2ff 100%);
      min-height:100vh;
      font-family: Inter, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;
      padding:20px;
    }
    .app {
      max-width: 720px;
      margin: 0 auto;
    }
    .card-main {
      border-radius: var(--card-radius);
      box-shadow: 0 8px 28px rgba(12, 32, 63, 0.08);
      overflow: hidden;
    }
    .header {
      background: linear-gradient(90deg,var(--primary),#1976d2);
      color: white;
      padding: 18px 20px;
    }
    .header h1{font-size:18px;margin:0;font-weight:600}
    .form-section { padding: 18px 20px; }
    .btn-ghost {
      background: transparent;
      border: 1px solid rgba(21,101,192,0.12);
    }
    .table-scroll { max-height: 380px; overflow:auto; }
    @media (max-width:420px){
      .header h1{font-size:16px}
    }
  </style>
</head>
<body>
  <div class="app">
    <div class="card card-main">
      <div class="header d-flex align-items-center justify-content-between">
        <div>
          <h1>ðŸ“… Pemesanan Meeting Room</h1>
          <div style="font-size:12px;opacity:.9">PT SSI â€” Sistem booking sederhana</div>
        </div>
        <div style="font-size:12px;opacity:.95">Mobile friendly</div>
      </div>

      <div class="form-section">
        <form id="orderForm" autocomplete="off">
          <div class="mb-2">
            <label class="form-label small">Nama Pemesan</label>
            <input id="nama" class="form-control" required placeholder="Nama lengkap"/>
          </div>

          <div class="mb-2">
            <label class="form-label small">Divisi / Unit</label>
            <input id="divisi" class="form-control" required placeholder="Contoh: HRD / Finance"/>
          </div>

          <div class="mb-2">
            <label class="form-label small">Ruang</label>
            <select id="ruang" class="form-select" required>
              <option value="">-- Pilih Ruangan --</option>
              <option>Ruang Lantai 3 - Marotai</option>
              <option>Ruang Lantai 3 - Natuna</option>
              <option>Ruang Lantai 2</option>
              <option>Ruang Lantai 1 - Rote</option>
            </select>
          </div>

          <div class="row g-2 mb-2">
            <div class="col-6">
              <label class="form-label small">Jam Mulai</label>
              <input id="jamMulai" type="time" class="form-control" required>
            </div>
            <div class="col-6">
              <label class="form-label small">Jam Akhir</label>
              <input id="jamAkhir" type="time" class="form-control" required>
            </div>
          </div>

          <div class="mb-3">
            <label class="form-label small">Acara</label>
            <textarea id="acara" rows="2" class="form-control" placeholder="Contoh: Rapat koordinasi" required></textarea>
          </div>

          <div class="d-grid gap-2">
            <button id="submitBtn" type="submit" class="btn btn-primary btn-lg">Pesan Ruangan</button>
            <div class="d-flex gap-2">
              <button id="lihatBtn" type="button" class="btn btn-outline-primary flex-fill">Lihat Data (20 terbaru)</button>
              <button id="refreshBtn" type="button" class="btn btn-ghost flex-fill">Refresh</button>
            </div>
          </div>
        </form>
      </div>

      <div class="p-3 border-top bg-white">
        <div class="d-flex align-items-center justify-content-between mb-2">
          <div><strong>Jadwal Terbaru</strong> <small class="text-muted">20 data</small></div>
          <div id="lastUpdated" class="small text-muted">â€”</div>
        </div>

        <div id="tableArea" class="table-scroll" style="display:none">
          <table class="table table-sm table-hover mb-0">
            <thead class="table-light small">
              <tr>
                <th style="min-width:140px">Timestamp</th>
                <th>Nama</th>
                <th class="text-nowrap">Divisi</th>
                <th>Ruang</th>
                <th class="text-nowrap">Jam Mulai</th>
                <th class="text-nowrap">Jam Akhir</th>
                <th>Acara</th>
              </tr>
            </thead>
            <tbody id="tableBody" class="small"></tbody>
          </table>
        </div>

        <div id="emptyArea" class="text-center text-muted py-3">Klik "Lihat Data" untuk memuat jadwal.</div>
      </div>
    </div>
  </div>

  <!-- Modal -->
  <div class="modal fade" id="modalResponse" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-sm modal-dialog-centered">
      <div class="modal-content">
        <div class="modal-body text-center p-3">
          <h6 id="modalTitle" class="mb-2"></h6>
          <div id="modalText" class="mb-3 small"></div>
          <div class="d-flex justify-content-center">
            <button class="btn btn-primary" data-bs-dismiss="modal">Tutup</button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Spinner for buttons (hidden) -->
  <template id="spinnerTpl">
    <span class="spinner-border spinner-border-sm ms-2" role="status" aria-hidden="true"></span>
  </template>

  <!-- Bootstrap JS -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>

  <script>
    // ======= CONFIG: ganti dengan URL Web App Apps Script kamu =======
    const SCRIPT_WEB_APP_URL = "https://script.google.com/macros/s/AKfycby8fr5S5k4WQDe_u06qzBfNGdPeI_hRpvQM9PuvcTQEI9gDx22sntUOlcqRbOMfSHxYiA/exec";
    // ==================================================================

    // Elements
    const orderForm = document.getElementById('orderForm');
    const submitBtn = document.getElementById('submitBtn');
    const lihatBtn = document.getElementById('lihatBtn');
    const refreshBtn = document.getElementById('refreshBtn');
    const tableArea = document.getElementById('tableArea');
    const tableBody = document.getElementById('tableBody');
    const emptyArea = document.getElementById('emptyArea');
    const lastUpdated = document.getElementById('lastUpdated');
    const modal = new bootstrap.Modal(document.getElementById('modalResponse'));
    const modalTitle = document.getElementById('modalTitle');
    const modalText = document.getElementById('modalText');
    const spinnerTpl = document.getElementById('spinnerTpl').content.firstElementChild;

    // Helper: show modal
    function showModal(title, text) {
      modalTitle.innerText = title;
      modalText.innerHTML = text;
      modal.show();
    }

    // Helper: format timestamp
    function fmt(ts) {
      try {
        const d = new Date(ts);
        if (isNaN(d)) return ts;
        return d.toLocaleString('id-ID', {hour12:false});
      } catch { return ts; }
    }

    // Submit form -> POST
    orderForm.addEventListener('submit', async (ev) => {
      ev.preventDefault();
      // disable
      submitBtn.disabled = true;
      const spinner = spinnerTpl.cloneNode(true);
      submitBtn.appendChild(spinner);

      const payload = {
        nama: document.getElementById('nama').value.trim(),
        divisi: document.getElementById('divisi').value.trim(),
        ruang: document.getElementById('ruang').value,
        jamMulai: document.getElementById('jamMulai').value,
        jamAkhir: document.getElementById('jamAkhir').value,
        acara: document.getElementById('acara').value.trim()
      };

      try {
        const res = await fetch(SCRIPT_WEB_APP_URL, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(payload)
        });

        // Jika server mengembalikan non-JSON (mis. scripts error), ini akan throw
        const json = await res.json();

        if (json.result === 'success') {
          showModal('âœ… Berhasil', 'Data pemesanan berhasil disimpan.');
          orderForm.reset();
          // otomatis refresh tabel bila sudah terbuka
          if (tableArea.style.display === 'block') {
            await loadLatest();
          }
        } else if (json.result === 'conflict') {
          const txt = `Ruangan <strong>${json.ruang}</strong> sudah dipesan pada jam <strong>${json.jamMulai}</strong> - <strong>${json.jamAkhir}</strong>. Silakan pilih jam/ruang lain.`;
          showModal('âš ï¸ Jadwal Bentrok', txt);
        } else {
          showModal('âŒ Gagal', 'Server mengembalikan error. Cek console untuk detail.');
          console.error('Unknown response:', json);
        }
      } catch (err) {
        console.error('Fetch error:', err);
        showModal('ðŸš« Koneksi Gagal', 'Tidak dapat terhubung ke server. Pastikan Apps Script sudah dideploy dan mengizinkan CORS.');
      } finally {
        // restore button
        submitBtn.disabled = false;
        if (submitBtn.contains(spinner)) submitBtn.removeChild(spinner);
      }
    });

    // Load latest 20 -> GET
    async function loadLatest() {
      // show loading
      lihatBtn.disabled = true;
      refreshBtn.disabled = true;
      lihatBtn.appendChild(spinnerTpl.cloneNode(true));
      tableBody.innerHTML = `<tr><td colspan="7" class="text-center py-3">Memuat data...</td></tr>`;
      emptyArea.style.display = 'none';
      tableArea.style.display = 'block';

      try {
        const res = await fetch(SCRIPT_WEB_APP_URL, { method: 'GET' });
        const data = await res.json();

        if (!Array.isArray(data) || data.length === 0) {
          tableBody.innerHTML = `<tr><td colspan="7" class="text-center text-muted py-3">Tidak ada data.</td></tr>`;
        } else {
          tableBody.innerHTML = '';
          data.forEach(row => {
            const tr = document.createElement('tr');

            const tstamp = row.timestamp ?? row.Timestamp ?? row[0] ?? '';
            const nama = row.nama ?? row.Nama ?? row[1] ?? '';
            const divisi = row.divisi ?? row.Divisi ?? row[2] ?? '';
            const ruang = row.ruang ?? row.Ruang ?? row[3] ?? '';
            const jamMulai = row.jamMulai ?? row['Jam Mulai'] ?? row[4] ?? '';
            const jamAkhir = row.jamAkhir ?? row['Jam Akhir'] ?? row[5] ?? '';
            const acara = row.acara ?? row.Acara ?? row[6] ?? '';

            tr.innerHTML = `
              <td style="min-width:140px">${fmt(tstamp)}</td>
              <td>${escapeHtml(nama)}</td>
              <td>${escapeHtml(divisi)}</td>
              <td>${escapeHtml(ruang)}</td>
              <td class="text-nowrap">${escapeHtml(jamMulai)}</td>
              <td class="text-nowrap">${escapeHtml(jamAkhir)}</td>
              <td>${escapeHtml(acara)}</td>
            `;
            tableBody.appendChild(tr);
          });
        }
        lastUpdated.innerText = new Date().toLocaleTimeString('id-ID', {hour12:false});
      } catch (err) {
        console.error('Load latest error:', err);
        tableBody.innerHTML = `<tr><td colspan="7" class="text-center text-danger py-3">Gagal memuat data.</td></tr>`;
        lastUpdated.innerText = 'error';
      } finally {
        // restore buttons
        lihatBtn.disabled = false;
        refreshBtn.disabled = false;
        const sp = lihatBtn.querySelector('.spinner-border');
        if (sp) sp.remove();
      }
    }

    // Escape HTML to avoid injection in table
    function escapeHtml(s) {
      if (s === null || s === undefined) return '';
      return String(s)
        .replaceAll('&', '&amp;')
        .replaceAll('<', '&lt;')
        .replaceAll('>', '&gt;')
        .replaceAll('"', '&quot;')
        .replaceAll("'", '&#039;');
    }

    // Buttons
    lihatBtn.addEventListener('click', async () => {
      await loadLatest();
    });
    refreshBtn.addEventListener('click', async () => {
      if (tableArea.style.display === 'block') {
        await loadLatest();
      } else {
        showModal('â„¹ï¸ Info', 'Tekan "Lihat Data" terlebih dahulu untuk memuat jadwal.');
      }
    });

    // Optional: auto-load on page open
    // window.addEventListener('load', () => { loadLatest(); });

  </script>
</body>
</html>
